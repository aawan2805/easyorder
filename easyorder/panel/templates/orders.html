{% extends "base.html" %}
{% load humanize %}

{% block messages %}
{% if messages %}
<ul class="messages">
    {% for message in messages %}
        {% if message.tags == 'success' %}
            <div class="alert alert-success" role="alert">
                {{ message }}
            </div>
        {% endif %}
        {% if message.tags == 'error' %}
            <div class="alert alert-error" role="alert">
                {{ message }}
            </div>
        {% endif %}
    {% endfor %}
</ul>
{% endif %}
{% endblock %}


{% block content %}
    <div class="row mt-2">
        {% if not object_list %}
            <div class="alert alert-primary" role="alert">
                No hay pedidos recientes.
            </div>
        {% else %}
            <table class="table" id="ordersTable">
                <thead>
                    <tr>
                        <th scope="col">Hora del pedido</th>
                        <th scope="col">Platos</th>
                        <th scope="col">Código</th>
                        <th scope="col">Hora de entrega</th>
                        <th scope="col">Estado</th>
                        <th scope="col">Importe</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        {% endif %}
          
    </div>
{% endblock %}

{% block script %}
<script type="text/javascript">
    // Load the data in JS
    var globalOrders =  JSON.parse('{{ object_list|escapejs }}');
    // Subscribe to WS
    function connect() {
        
        let brand_uuid = globalOrders.brand_uuid;
        console.log(brand_uuid)
        console.log(window.location.host)
        chatSocket = new WebSocket("ws://" + window.location.host + "/orders/brand/" + brand_uuid );

        chatSocket.onopen = function(e) {
            console.log("Successfully connected to the WebSocket.");
            chatSocket.send(JSON.stringify({
                "message": "Conectado",
            }));
        }

        chatSocket.onclose = function(e) {
            console.log("WebSocket connection closed unexpectedly. Trying to reconnect in 2s...");
            // setTimeout(function() {
            //     console.log("Reconnecting...");
            //     connect();
            // }, 2000);
        };

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const order = JSON.parse(data.message)
            globalOrders.orders.unshift(order)
            console.log(order)
            console.log(globalOrders)
            makeTable(globalOrders);
        };

        chatSocket.onerror = function(err) {
            console.log("WebSocket encountered an error: " + err.message);
            console.log("Closing the socket.");
            chatSocket.close();
        }
    }


    selected_unselect = (e, order) => {
        e.preventDefault()
        globalOrders.orders.forEach((element, index) => {
            if(element.id != order.id && element.selected === true){
                globalOrders.orders[index].selected = false;
                makeTable(globalOrders);
            } else if(element.id == order.id && element.selected === false) {
                globalOrders.orders[index].selected = true;
                makeTable(globalOrders);
            }
        })
    }


    function makeTable(orders) {
        console.log("making table...", orders.orders.length)

        const ordersTableBody = document.querySelector('#ordersTable tbody');
        ordersTableBody.innerHTML = "";

        orders.orders.forEach(order => {
            const row = document.createElement('tr');

            const orderIdCell = document.createElement('td');
            orderIdCell.textContent = order.order_placed_at;
            row.appendChild(orderIdCell);

            const orderPlacedAtCell = document.createElement('td');
            order.dishes.forEach(dish => {
                span = document.createElement('span');
                span.setAttribute("class", "badge text-bg-success")
                span.innerHTML = dish
                orderPlacedAtCell.appendChild(span)
            })
            row.appendChild(orderPlacedAtCell);

            const orderDeliveredAtCell = document.createElement('td');
            orderDeliveredAtCell.textContent = order.collection_code;
            row.appendChild(orderDeliveredAtCell);

            const wsCodeCell = document.createElement('td');
            wsCodeCell.textContent = order.order_delivered_at;
            row.appendChild(wsCodeCell);


            const statusCell = document.createElement('td');
            // Create form element
            const form = document.createElement('form');
            form.name = 'status';
            form.method = 'get';

            // Create select element
            const select = document.createElement('select');
            select.className = 'form-select';
            select.name = 'status';
            select.id = 'status';

            // Create option elements and add them to select element
            const options = [
                {value: '0', text: 'ORDER PLACED'},
                {value: '1', text: 'ORDER ACCEPTED'},
                {value: '2', text: 'PREPARING ORDER'},
                {value: '3', text: 'ORDER PREPARED'},
                {value: '4', text: 'ORDER DELIVERED'}
            ];
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = option.text;
                select.appendChild(opt);
            });

            row.onmouseover = function (e) {
                selected_unselect(e, order);
            }

            // Create submit button
            const button = document.createElement('button');
            button.type = 'submit';
            button.className = 'btn btn-primary';
            button.textContent = 'Change';

            // Add select element and button to form element
            form.appendChild(select);
            form.appendChild(button);

            // Add form element to the DOM
            statusCell.append(form)
            row.appendChild(statusCell);


            const brandIdCell = document.createElement('td');
            brandIdCell.textContent = order.amount.toFixed(2) + "€";
            row.appendChild(brandIdCell);

            if(order.selected === true){
                row.setAttribute("class", "bg-info text-white")
            }

            ordersTableBody.appendChild(row);

        });
    }
    connect();
    makeTable(globalOrders);

</script>
{% endblock %}

